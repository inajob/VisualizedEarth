<!DOCTYPE html>
<html>
<head>
<title>Visualized Earth +</title>
<meta charset="utf-9" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<!-- <link href='https://fonts.googleapis.com/css?family=Lato:400,100,300,900' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Oswald:400,700,300' rel='stylesheet' type='text/css'> -->
<link href='https://fonts.googleapis.com/css?family=Quicksand:400,700,300' rel='stylesheet' type='text/css'>
<style>
*{
  margin:0px;
  padding:0px;
}
html,body{
  width:100%;
  height:100%;
  background: url(./img/bg.jpg);
  background-size: cover;
}
#map{
  width:100%;
  height:100%;
  background-color:transparent;
}

.routePath{
  transition: stroke-dashoffset 5s linear;
  stroke-dasharray:2 2 12 2;
  stroke-dashoffset:200;
  stroke-linecap:butt;
  stroke-linejoin:miter;
}
.outerCircle{
  stroke-dasharray:4;
  stroke-linecap:butt;
}

.logo{
  position:absolute;
  top:10px;
  left:10px;
  width: 240px;
  height: 94px;
  color:white;
  font-size:50px;/*
  font-family: 'Quicksand', 'Sacramento', helvetica;
  font-weight: 300;*/
  line-height: 1.1;
  background: url(./img/logo.png) no-repeat center;
  background-size: 100%;
  text-indent: -9999px;
  overflow: hidden;
}
#searchControl{
  position:absolute;
  bottom:10px;
  left:10px;
  width:300px;
}
#searchControl input{
  background-color:rgba(255,255,255,0.05);
  border:solid rgba(255,255,255,0.2) 1px;
  color:white;
  outline:none;
  padding:6px 10px;
  border-radius: 4px;
}

#searchControl input:first-child{
  border-bottom-right-radius: 0;
  border-top-right-radius: 0;
  border-right: 0;
  width: 200px;
}

#searchControl input:last-child{
  border-bottom-left-radius: 0;
  border-top-left-radius: 0;
  background-color: #fff;
  color: #333;
  font-weight: bold;
}


.label{
  color:white;
}

</style>

</head>
<body>
<div id="map"></div>
<h1 class="logo">Visualize+</h1>
<div id="searchControl">
  <input id="searchText" type="text" /><input id="searchButton" type="button" value="ROUTE" />
</div>
<script src="" type="text/javascript"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

<script>

$.ajax({
  type: 'GET',
  url: 'http://210-140-161-175.jp-east.compute.idcfcloud.com/index.php',
  dataType: 'jsonp',
  jsonpCallback: 'CALLBACK',
  success: function(json){
    console.log(json);
  }
});

var map = L.map("map", {zoomControl:false,attributionControl:false});
map.setView([39.74739, 140], 3);

L.control.zoom({
  position: 'topright'
}).addTo(map);

var pathLayer = L.layerGroup();

/*
var wmsLayer = L.tileLayer.wms('http://demo.opengeo.org/geoserver/ows?', {
    layers: 'nasa:bluemarble'
}).addTo(map);
*/

var style = {
  color: "#56C1FF",
  //fillColor: "#ffffff",
  fillColor: "#74858F",
  weight:0.5,
  //weight:5,
  fillOpacity:0.2
};




var wmsLayer = L.tileLayer.wms('http://nowcoast.noaa.gov/arcgis/services/nowcoast/analysis_meteohydro_sfc_qpe_time/MapServer/WmsServer?', {
    layers: '5',
    transparent:true,
    format:'image/png'
    });



$.getJSON("./data/countries-mid.geojson", function(data) {
    var baseLayer = L.layerGroup();
    var geojson = L.geoJson(data, {
        style: style,
        //onEachFeature: function (feature, layer) {
        //    layer.bindPopup(feature.properties.name);
        //},
        coordsToLatLng:function(coords){return new L.LatLng(coords[1], coords[0], coords[2]);}
    });
    baseLayer.addLayer(geojson);

    var geojson2 = L.geoJson(data, {
        style: style,
        coordsToLatLng:function(coords){return new L.LatLng(coords[1], coords[0] + 360, coords[2]);}
    });
    baseLayer.addLayer(geojson2);
    baseLayer.addTo(map);

    var emptyLayer = L.layerGroup();

    // === external resources ==
    var riverLayer = L.tileLayer.wms('http://www.bgr.de/Service/groundwater/whymap/?', {
        layers: 'River',
        transparent:true,
        format:'image/png'
        });
    var lowRainFallLayer = L.tileLayer.wms('http://www.bgr.de/Service/groundwater/whymap/?', {
        layers: 'Nonreneg',
        transparent:true,
        format:'image/png'
        });
    var iceLayer = L.tileLayer.wms('http://www.bgr.de/Service/groundwater/whymap/?', {
        layers: 'ice',
        transparent:true,
        format:'image/png'
        });

    //http://sedac.ciesin.columbia.edu/maps/services
    var nuclearLayer = L.tileLayer.wms('http://sedac.ciesin.org/geoserver/ows?', {
      layers: 'energy:energy-pop-exposure-nuclear-plants-locations_plants',
      transparent:true,
      format:'image/png'
    });

    var climateEffectsLayer = L.tileLayer.wms('http://sedac.ciesin.org/geoserver/ows?', {
      layers: 'crop-climate:crop-climate-effects-climate-global-food-production',
      transparent:true,
      format:'image/png'
    });

    var populationLayer = L.tileLayer.wms('http://sedac.ciesin.org/geoserver/ows?', {
      layers: 'gpw-v3:gpw-v3-population-density-future-estimates_2015',
      transparent:true,
      format:'image/png',
      opacity:0.3
    });
    // ==================================

    L.control.layers(
      {
        outline: baseLayer,
        population2015: populationLayer,
        "Effects of Climate Change on Global Food Production": climateEffectsLayer,
      }, // base
      {
        path: pathLayer,
        wms: wmsLayer,
        river: riverLayer,
        ice: iceLayer,
        nuclear: nuclearLayer,
        "low rain fall": lowRainFallLayer,
      }, // over
      {
      position: 'bottomright'
    }).addTo(map);


    // ======= trace control ======
    function goTrace(){
      var value = $('#searchText').val();

      // todo: trace code
      var pathList = [[35, 139]];
      var len = Math.random() * 5 + 2;
      for(var i = 0; i < len; i ++){
        pathList.push([(Math.random() - 0.5) * (180-50), Math.random() * 360]);
      }
      clearTrace();
      showRoute(pathList);

      animatePath();

    }
    var keyDownCode = 0;
    $('#searchButton').click(function(e){goTrace()});
    $('#searchText').keydown(function(e){
      keyDownCode = e.which;
    });
    $('#searchText').keyup(function(e){
      if(e.which == 13 && e.which == keyDownCode){
        // enter
        goTrace();
      }
    });
    // ==============================

});

function clearTrace(){
  pathLayer.clearLayers();
}

function showRoute(pathList){
  // line
  var polyline = L.polyline(pathList, {
    color: '#fff',
    className:'routePath',
    weight: 4,
    opacity: 0.3
  });
  pathLayer.addLayer(polyline);

  pathLayer.addTo(map);

  //var endColor = '#50DA55';
  var endColor = '#FF7D1D';


  // point effect
  function drawMarker(p){

      // var circle = L.circleMarker([p[0], p[1]], {
      //   radius: 18,
      //   weight:8,
      //   color: endColor,
      //   fillColor:'transparent',
      //   opacity: 0.4,
      //   className:'outerCircle',
      // });
      // pathLayer.addLayer(circle);

      var circle = L.circleMarker([p[0], p[1]], {
        radius: 0,
        color: endColor,
        fillColor:'transparent',
        opacity: 1,
        weight: 6
      });
      pathLayer.addLayer(circle);

       var circle = L.circleMarker([p[0], p[1]], {
        radius: 5,
        weight:1,
        color: endColor,
        fillColor:'transparent',
        opacity: 0.8
      });
      pathLayer.addLayer(circle);

       var circle = L.circleMarker([p[0], p[1]], {
        radius: 9,
        weight:4,
        color: endColor,
        fillColor:'transparent',
        opacity: 0.8
      });
      pathLayer.addLayer(circle);

      // var circle = L.circleMarker([p[0], p[1]], {
      //   radius: 25,
      //   weight:2,
      //   color: endColor,
      //   fillColor:'transparent',
      //   opacity: 0.4
      // });
      // pathLayer.addLayer(circle);

  }
  function drawSmallMarker(p){
      var circle = L.circleMarker([p[0], p[1]], {
        radius: 0,
        color: '#56C1FF',
        fillColor:'transparent',
        opacity: 0.8,
        weight: 6
      });
      pathLayer.addLayer(circle);
      // var circle = L.circleMarker([p[0], p[1]], {
      //   radius: 7,
      //   color: '#fff',
      //   fillColor:'transparent',
      //   opacity: 0.5,
      //   weight: 2,
      // });
      // pathLayer.addLayer(circle);
      var circle = L.circleMarker([p[0], p[1]], {
        radius: 6,
        color: '#fff',
        fillColor:'transparent',
        opacity: 0.3,
        weight: 3,
      });
      pathLayer.addLayer(circle);

      var label = L.divIcon({className: 'label', html: 'TEST'});
      var labelMarker = L.marker([p[0] - 2, p[1] - 3], {icon: label});
      pathLayer.addLayer(labelMarker);
  }

  drawMarker(pathList[pathList.length - 1],5);

  if(pathList.length > 1){
  for(var i = 0; i < pathList.length - 1; i ++){
    drawSmallMarker(pathList[i]);
  }
}


}

var pathList = [
  [35, 139],
  [35, 250],
  [45, 280],
  [60, 210]
];
showRoute(pathList);



// ====== animation =====
function animatePath(){
  setTimeout(function(){

    $('.routePath').css('stroke-dashoffset', 200);
    setTimeout(function(){
      $('.routePath').css('stroke-dashoffset', 0);
    },10);
  },1);
}
animatePath();
// =======================

</script>

</body>
</html>
